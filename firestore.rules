rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // REGRAS DE SEGURANÇA - BARBER SHOP AGENDAMENTOS
    // ============================================================================
    
    // 1. COLEÇÃO BARBERS (Perfil das Barbearias)
    // Leitura: PÚBLICA (Necessário para carregar a página da barbearia)
    // Escrita: Apenas o PRÓPRIO DONO (Barbeiro autenticado com ID correspondente)
    match /barbers/{barberId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == barberId;

      // 1.1 SERVIÇOS (Subcoleção)
      // Leitura: PÚBLICA (Para clientes escolherem serviços)
      // Escrita: Apenas o DONO
      match /services/{serviceId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == barberId;
      }

      // 1.2 GALERIA (Subcoleção)
      // Leitura: PÚBLICA
      // Escrita: Apenas o DONO
      match /gallery/{imageId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == barberId;
      }

      // 1.3 PROMOÇÕES (Subcoleção)
      // Leitura: PÚBLICA
      // Escrita: Apenas o DONO
      match /promotions/{promoId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == barberId;
      }
      
      // 1.4 AGENDAMENTOS (Subcoleção)
      // Criação: PÚBLICA (Clientes criam agendamentos)
      // Leitura/Edição/Deleção: Apenas o DONO (Para gerenciar agenda)
      match /appointments/{appointmentId} {
        allow create: if true;
        allow read, update, delete: if request.auth != null && request.auth.uid == barberId;
      }

      // 1.5 CLIENTES (Subcoleção)
      // Acesso total: Apenas o DONO (Dados sensíveis de clientes)
      match /clients/{clientId} {
        allow read, write: if request.auth != null && request.auth.uid == barberId;
      }

      // 1.6 TRANSAÇÕES (Subcoleção)
      // Acesso total: Apenas o DONO (Dados financeiros)
      match /transactions/{transactionId} {
        allow read, write: if request.auth != null && request.auth.uid == barberId;
      }
    }

    // 2. FIDELIDADE (Coleção Raiz)
    // Usada para rastrear pontos de fidelidade.
    // Acesso: Qualquer usuário autenticado (Barbeiro) pode ler/escrever.
    // Melhoria futura: Restringir para que o barbeiro só edite fidelidade vinculada a ele.
    match /loyaltyClients/{loyaltyId} {
      allow read, write: if request.auth != null;
    }
  }
}
